# WKU 소프트웨어 Crew Project - 기술 아키텍처

## 1. 시스템 아키텍처 개요

### 1.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENT LAYER                          │
├─────────────────────────────────────────────────────────────┤
│  Web App (React/Next.js)  │  Mobile (React Native - Future) │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                         CDN / EDGE                           │
│                  (CloudFlare / AWS CloudFront)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      LOAD BALANCER                           │
│                    (AWS ALB / Nginx)                         │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┴───────────────────┐
          ↓                                       ↓
┌──────────────────────┐              ┌──────────────────────┐
│   API GATEWAY        │              │   WebSocket Server   │
│   (Node.js/NestJS)   │              │   (Socket.io)        │
└──────────────────────┘              └──────────────────────┘
          │                                       │
          └───────────────────┬───────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   APPLICATION LAYER                          │
├──────────────┬──────────────┬──────────────┬────────────────┤
│  Auth        │  LMS         │  IDE         │  Project       │
│  Service     │  Service     │  Service     │  Service       │
├──────────────┼──────────────┼──────────────┼────────────────┤
│  Community   │  Mentor      │  Startup     │  Analytics     │
│  Service     │  Service     │  Service     │  Service       │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┴───────────────────┐
          ↓                   ↓                   ↓
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   PostgreSQL     │ │   Redis          │ │   MongoDB        │
│   (Primary DB)   │ │   (Cache/Queue)  │ │   (Logs/Events)  │
└──────────────────┘ └──────────────────┘ └──────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    STORAGE & EXTERNAL                        │
├──────────────┬──────────────┬──────────────┬────────────────┤
│  AWS S3      │  GitHub API  │  Docker      │  Email/SMS     │
│  (Files)     │  (Git)       │  Registry    │  (SendGrid)    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 아키텍처 패턴

**Microservices Architecture**
- 독립적으로 배포 가능한 서비스
- 서비스 간 REST API / gRPC 통신
- Event-driven 아키텍처 (일부)

**장점**:
- 확장성: 서비스별 독립 스케일링
- 유지보수: 서비스별 독립 개발/배포
- 기술 다양성: 서비스별 최적 기술 선택

**단점**:
- 복잡성 증가
- 분산 트랜잭션 어려움
- 네트워크 레이턴시

---

## 2. 프론트엔드 아키텍처

### 2.1 기술 스택

#### Core Framework
- **Next.js 14** (App Router)
  - React 18 기반
  - Server Components
  - 서버 사이드 렌더링 (SSR)
  - Static Site Generation (SSG)
  - Incremental Static Regeneration (ISR)

#### UI/UX
- **TailwindCSS**: 유틸리티 퍼스트 CSS
- **Shadcn/ui**: 컴포넌트 라이브러리
- **Radix UI**: Headless UI 컴포넌트
- **Framer Motion**: 애니메이션

#### State Management
- **Zustand**: 글로벌 상태 관리 (경량)
- **React Query (TanStack Query)**: 서버 상태 관리
- **Context API**: 로컬 상태

#### Code Editor
- **Monaco Editor**: VS Code 에디터 엔진
- **CodeMirror**: 대안 에디터 (경량)

#### Real-time Communication
- **Socket.io Client**: WebSocket 통신
- **Y.js**: CRDT 기반 협업 편집

#### Testing
- **Vitest**: 단위 테스트
- **Playwright**: E2E 테스트
- **Testing Library**: 컴포넌트 테스트

### 2.2 폴더 구조

```
src/
├── app/                    # Next.js App Router
│   ├── (auth)/            # 인증 관련 페이지
│   │   ├── login/
│   │   ├── register/
│   │   └── layout.tsx
│   ├── (dashboard)/       # 대시보드 레이아웃
│   │   ├── courses/
│   │   ├── projects/
│   │   ├── community/
│   │   └── layout.tsx
│   ├── (ide)/            # IDE 전체화면
│   │   └── editor/[projectId]/
│   └── api/              # API Routes
│       ├── auth/
│       └── webhooks/
├── components/
│   ├── ui/               # 기본 UI 컴포넌트
│   ├── features/         # 기능별 컴포넌트
│   │   ├── auth/
│   │   ├── course/
│   │   ├── editor/
│   │   └── project/
│   ├── layouts/          # 레이아웃 컴포넌트
│   └── shared/           # 공유 컴포넌트
├── lib/                  # 유틸리티 함수
│   ├── api.ts           # API 클라이언트
│   ├── auth.ts          # 인증 유틸
│   └── utils.ts         # 공통 유틸
├── hooks/               # Custom Hooks
│   ├── useAuth.ts
│   ├── useCourse.ts
│   └── useEditor.ts
├── stores/              # Zustand Stores
│   ├── authStore.ts
│   ├── editorStore.ts
│   └── projectStore.ts
├── types/               # TypeScript 타입
│   ├── user.ts
│   ├── course.ts
│   └── project.ts
└── styles/              # 글로벌 스타일
    └── globals.css
```

### 2.3 주요 기능 구현

#### 2.3.1 Monaco Editor 통합

```typescript
// components/features/editor/MonacoEditor.tsx
import { Editor } from '@monaco-editor/react';
import { useEffect, useRef } from 'use';

export function MonacoEditor({
  projectId,
  initialCode,
  language = 'javascript'
}) {
  const editorRef = useRef(null);
  const monacoRef = useRef(null);

  function handleEditorDidMount(editor, monaco) {
    editorRef.current = editor;
    monacoRef.current = monaco;

    // VS Code 테마 적용
    monaco.editor.defineTheme('wku-dark', {
      base: 'vs-dark',
      inherit: true,
      rules: [],
      colors: {}
    });

    // 키바인딩 설정
    editor.addCommand(
      monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S,
      () => handleSave()
    );
  }

  return (
    <Editor
      height="100vh"
      language={language}
      theme="wku-dark"
      defaultValue={initialCode}
      onMount={handleEditorDidMount}
      options={{
        fontSize: 14,
        minimap: { enabled: true },
        scrollBeyondLastLine: false,
        automaticLayout: true,
      }}
    />
  );
}
```

#### 2.3.2 실시간 협업 (Y.js)

```typescript
// lib/collaboration/yjs.ts
import * as Y from 'yjs';
import { WebsocketProvider } from 'y-websocket';
import { MonacoBinding } from 'y-monaco';

export function setupCollaboration(
  editor: any,
  monaco: any,
  projectId: string,
  userId: string
) {
  const ydoc = new Y.Doc();
  const ytext = ydoc.getText('monaco');

  // WebSocket 연결
  const provider = new WebsocketProvider(
    'wss://api.wkucrew.com/collab',
    projectId,
    ydoc,
    {
      params: { userId }
    }
  );

  // Monaco 바인딩
  const binding = new MonacoBinding(
    ytext,
    editor.getModel(),
    new Set([editor]),
    provider.awareness
  );

  return { ydoc, provider, binding };
}
```

---

## 3. 백엔드 아키텍처

### 3.1 기술 스택

#### Core Framework
- **Node.js 20 LTS**
- **NestJS**: 엔터프라이즈급 프레임워크
  - TypeScript 기반
  - 모듈화 아키텍처
  - Dependency Injection
  - 데코레이터 기반

#### Database
- **PostgreSQL 15**: 메인 데이터베이스
  - User, Course, Project 데이터
  - Prisma ORM
- **Redis 7**: 캐싱 및 세션
  - 세션 스토어
  - 캐시 레이어
  - 작업 큐 (Bull)
- **MongoDB**: 로그 및 이벤트
  - 활동 로그
  - 분석 이벤트

#### Authentication
- **Passport.js**: 인증 전략
  - Local Strategy (이메일/비밀번호)
  - GitHub OAuth
  - Google OAuth
- **JWT**: 토큰 기반 인증
- **bcrypt**: 비밀번호 해싱

#### Real-time
- **Socket.io**: WebSocket 통신
- **Redis Adapter**: 멀티 서버 지원

#### File Storage
- **AWS S3**: 파일 저장소
  - 프로필 이미지
  - 프로젝트 파일
  - 동영상 (HLS)

#### Queue & Job Processing
- **Bull**: Redis 기반 작업 큐
  - 이메일 발송
  - 비디오 인코딩
  - 통계 계산

#### Search
- **ElasticSearch**: 전문 검색
  - 코스 검색
  - 커뮤니티 검색

#### Monitoring
- **Prometheus + Grafana**: 모니터링
- **Sentry**: 에러 추적
- **Winston**: 로깅

### 3.2 폴더 구조 (NestJS)

```
src/
├── main.ts                # 애플리케이션 진입점
├── app.module.ts         # 루트 모듈
├── common/               # 공통 모듈
│   ├── decorators/
│   ├── filters/
│   ├── guards/
│   ├── interceptors/
│   ├── pipes/
│   └── utils/
├── config/               # 설정
│   ├── database.config.ts
│   ├── jwt.config.ts
│   └── s3.config.ts
├── modules/
│   ├── auth/            # 인증 모듈
│   │   ├── auth.controller.ts
│   │   ├── auth.service.ts
│   │   ├── auth.module.ts
│   │   ├── strategies/
│   │   │   ├── jwt.strategy.ts
│   │   │   ├── github.strategy.ts
│   │   │   └── google.strategy.ts
│   │   └── dto/
│   ├── user/            # 사용자 모듈
│   │   ├── user.controller.ts
│   │   ├── user.service.ts
│   │   ├── user.module.ts
│   │   ├── entities/
│   │   └── dto/
│   ├── course/          # 코스 모듈
│   │   ├── course.controller.ts
│   │   ├── course.service.ts
│   │   ├── course.module.ts
│   │   └── ...
│   ├── project/         # 프로젝트 모듈
│   ├── ide/             # IDE 모듈
│   ├── community/       # 커뮤니티 모듈
│   ├── mentor/          # 멘토링 모듈
│   ├── startup/         # 창업 지원 모듈
│   └── analytics/       # 분석 모듈
└── prisma/
    └── schema.prisma    # Prisma 스키마
```

### 3.3 데이터베이스 스키마 (Prisma)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User 모델
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // OAuth 사용자는 null
  name          String
  avatar        String?
  bio           String?
  department    String
  grade         Int
  level         Int       @default(1)
  xp            Int       @default(0)

  // OAuth
  githubId      String?   @unique
  googleId      String?   @unique

  // 관계
  enrollments   Enrollment[]
  projects      ProjectMember[]
  posts         Post[]
  comments      Comment[]
  mentorSessions MentorSession[] @relation("Mentee")
  mentoredSessions MentorSession[] @relation("Mentor")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@map("users")
}

// Course 모델
model Course {
  id            String    @id @default(cuid())
  title         String
  description   String
  level         CourseLevel
  duration      Int       // 분 단위
  thumbnail     String?
  published     Boolean   @default(false)

  // 관계
  chapters      Chapter[]
  enrollments   Enrollment[]
  instructorId  String
  instructor    User      @relation(fields: [instructorId], references: [id])

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([level, published])
  @@map("courses")
}

enum CourseLevel {
  JUNIOR
  SENIOR
  MASTER
}

// Chapter 모델
model Chapter {
  id            String    @id @default(cuid())
  title         String
  order         Int
  content       String    @db.Text
  videoUrl      String?
  duration      Int?

  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  assignments   Assignment[]
  progresses    Progress[]

  @@index([courseId, order])
  @@map("chapters")
}

// Enrollment (수강 신청)
model Enrollment {
  id            String    @id @default(cuid())

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  progress      Int       @default(0) // 0-100
  completedAt   DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, courseId])
  @@map("enrollments")
}

// Progress (학습 진행)
model Progress {
  id            String    @id @default(cuid())

  userId        String
  chapterId     String
  chapter       Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  completed     Boolean   @default(false)
  lastPosition  Int       @default(0) // 동영상 마지막 위치 (초)

  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, chapterId])
  @@map("progresses")
}

// Project 모델
model Project {
  id            String    @id @default(cuid())
  name          String
  description   String?
  visibility    Visibility @default(PRIVATE)

  githubRepo    String?
  deployUrl     String?

  members       ProjectMember[]
  files         ProjectFile[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("projects")
}

enum Visibility {
  PUBLIC
  PRIVATE
  TEAM
}

// ProjectMember
model ProjectMember {
  id            String    @id @default(cuid())

  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  role          ProjectRole @default(EDITOR)

  joinedAt      DateTime  @default(now())

  @@unique([projectId, userId])
  @@map("project_members")
}

enum ProjectRole {
  OWNER
  EDITOR
  VIEWER
}

// Post (커뮤니티)
model Post {
  id            String    @id @default(cuid())
  title         String
  content       String    @db.Text
  tags          String[]
  upvotes       Int       @default(0)

  authorId      String
  author        User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  comments      Comment[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([authorId])
  @@map("posts")
}

// Comment
model Comment {
  id            String    @id @default(cuid())
  content       String    @db.Text
  upvotes       Int       @default(0)

  postId        String
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId      String
  author        User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  parentId      String?   // 대댓글
  parent        Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[] @relation("CommentReplies")

  accepted      Boolean   @default(false) // 채택된 답변

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([postId])
  @@map("comments")
}

// MentorSession
model MentorSession {
  id            String    @id @default(cuid())

  mentorId      String
  mentor        User      @relation("Mentor", fields: [mentorId], references: [id])

  menteeId      String
  mentee        User      @relation("Mentee", fields: [menteeId], references: [id])

  topic         String
  description   String?
  status        SessionStatus @default(PENDING)

  scheduledAt   DateTime
  completedAt   DateTime?

  rating        Int?      // 1-5
  review        String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("mentor_sessions")
}

enum SessionStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  CANCELLED
}
```

### 3.4 주요 서비스 구현

#### 3.4.1 인증 서비스

```typescript
// modules/auth/auth.service.ts
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../prisma/prisma.service';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
  ) {}

  async register(dto: RegisterDto) {
    const hashedPassword = await bcrypt.hash(dto.password, 10);

    const user = await this.prisma.user.create({
      data: {
        email: dto.email,
        password: hashedPassword,
        name: dto.name,
        department: dto.department,
        grade: dto.grade,
      },
    });

    // 이메일 인증 발송
    await this.sendVerificationEmail(user.email);

    return { message: '회원가입 성공. 이메일을 확인해주세요.' };
  }

  async login(dto: LoginDto) {
    const user = await this.prisma.user.findUnique({
      where: { email: dto.email },
    });

    if (!user || !user.password) {
      throw new UnauthorizedException('이메일 또는 비밀번호가 틀렸습니다.');
    }

    const isPasswordValid = await bcrypt.compare(dto.password, user.password);

    if (!isPasswordValid) {
      throw new UnauthorizedException('이메일 또는 비밀번호가 틀렸습니다.');
    }

    const payload = { sub: user.id, email: user.email };
    const accessToken = this.jwtService.sign(payload);
    const refreshToken = this.jwtService.sign(payload, { expiresIn: '30d' });

    return {
      accessToken,
      refreshToken,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
      },
    };
  }

  async githubLogin(profile: any) {
    let user = await this.prisma.user.findUnique({
      where: { githubId: profile.id },
    });

    if (!user) {
      user = await this.prisma.user.create({
        data: {
          githubId: profile.id,
          email: profile.email,
          name: profile.displayName,
          avatar: profile.avatar_url,
        },
      });
    }

    const payload = { sub: user.id, email: user.email };
    const accessToken = this.jwtService.sign(payload);

    return { accessToken, user };
  }
}
```

#### 3.4.2 실시간 협업 서비스

```typescript
// modules/ide/ide.gateway.ts
import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  OnGatewayConnection,
  OnGatewayDisconnect,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';

@WebSocketGateway({
  namespace: '/collab',
  cors: { origin: '*' },
})
export class IdeGateway implements OnGatewayConnection, OnGatewayDisconnect {
  @WebSocketServer()
  server: Server;

  private projectRooms: Map<string, Set<string>> = new Map();

  async handleConnection(client: Socket) {
    const { projectId, userId } = client.handshake.query;

    if (!projectId || !userId) {
      client.disconnect();
      return;
    }

    // 프로젝트 방에 참가
    client.join(projectId as string);

    // 활성 사용자 추가
    if (!this.projectRooms.has(projectId as string)) {
      this.projectRooms.set(projectId as string, new Set());
    }
    this.projectRooms.get(projectId as string).add(userId as string);

    // 다른 사용자에게 알림
    client.to(projectId as string).emit('user:joined', {
      userId,
      socketId: client.id,
    });

    // 현재 활성 사용자 목록 전송
    client.emit('users:active', {
      users: Array.from(this.projectRooms.get(projectId as string)),
    });
  }

  async handleDisconnect(client: Socket) {
    const { projectId, userId } = client.handshake.query;

    if (projectId && userId) {
      this.projectRooms.get(projectId as string)?.delete(userId as string);

      client.to(projectId as string).emit('user:left', { userId });
    }
  }

  @SubscribeMessage('code:change')
  handleCodeChange(client: Socket, payload: any) {
    const { projectId } = client.handshake.query;

    // 자신을 제외한 방의 모든 사용자에게 브로드캐스트
    client.to(projectId as string).emit('code:change', payload);
  }

  @SubscribeMessage('cursor:move')
  handleCursorMove(client: Socket, payload: any) {
    const { projectId } = client.handshake.query;

    client.to(projectId as string).emit('cursor:move', {
      userId: client.handshake.query.userId,
      ...payload,
    });
  }
}
```

---

## 4. 인프라 아키텍처

### 4.1 클라우드 제공자: AWS

#### 컴퓨팅
- **ECS (Elastic Container Service)**: 컨테이너 오케스트레이션
  - Fargate: 서버리스 컨테이너
  - Auto Scaling
- **Lambda**: 서버리스 함수
  - 이미지 리사이징
  - 이메일 발송
  - 통계 집계

#### 네트워킹
- **ALB (Application Load Balancer)**: L7 로드 밸런서
- **CloudFront**: CDN
- **Route 53**: DNS

#### 스토리지
- **S3**: 오브젝트 스토리지
  - 프로필 이미지
  - 프로젝트 파일
  - 동영상 (HLS)
- **EFS (Elastic File System)**: 공유 파일 시스템 (IDE 파일)

#### 데이터베이스
- **RDS PostgreSQL**: 관리형 데이터베이스
  - Multi-AZ 배포
  - 자동 백업
- **ElastiCache Redis**: 관리형 Redis
  - 클러스터 모드

#### 보안
- **VPC**: 가상 사설 네트워크
- **Security Groups**: 방화벽
- **IAM**: 권한 관리
- **Secrets Manager**: 비밀 관리
- **WAF**: 웹 애플리케이션 방화벽

### 4.2 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        INTERNET                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      Route 53 (DNS)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   CloudFront (CDN)                           │
│  - 정적 assets (JS, CSS, Images)                            │
│  - 캐시 정책                                                │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┴───────────────────┐
          ↓                                       ↓
┌──────────────────────┐              ┌──────────────────────┐
│   S3 (Static Web)    │              │   ALB                │
│   - Next.js Build    │              │   (Load Balancer)    │
└──────────────────────┘              └──────────────────────┘
                                                  │
                              ┌───────────────────┴───────────────────┐
                              ↓                                       ↓
                    ┌──────────────────────┐              ┌──────────────────────┐
                    │   ECS Cluster        │              │   ECS Cluster        │
                    │   (API Servers)      │              │   (WebSocket)        │
                    │   - NestJS           │              │   - Socket.io        │
                    │   - Auto Scaling     │              │   - Redis Adapter    │
                    └──────────────────────┘              └──────────────────────┘
                              │                                       │
                              └───────────────────┬───────────────────┘
                                                  ↓
                              ┌─────────────────────────────────────┐
                              │        VPC (Private Subnet)         │
                              ├──────────────┬──────────────────────┤
                              │  RDS         │  ElastiCache Redis   │
                              │  PostgreSQL  │  (Cluster)           │
                              └──────────────┴──────────────────────┘
```

### 4.3 CI/CD 파이프라인

#### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test
      - run: npm run lint

  build-and-deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run build
      - name: Deploy to S3
        run: aws s3 sync ./out s3://wkucrew-frontend
      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CF_DIST_ID }} --paths "/*"

  build-and-deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Image
        run: docker build -t wkucrew-api:latest .
      - name: Push to ECR
        run: |
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          docker tag wkucrew-api:latest ${{ secrets.ECR_REGISTRY }}/wkucrew-api:latest
          docker push ${{ secrets.ECR_REGISTRY }}/wkucrew-api:latest
      - name: Deploy to ECS
        run: aws ecs update-service --cluster wkucrew-cluster --service api-service --force-new-deployment
```

---

## 5. 보안 아키텍처

### 5.1 인증 및 권한

#### JWT 토큰 구조
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-id",
    "email": "user@wku.ac.kr",
    "role": "STUDENT",
    "iat": 1640000000,
    "exp": 1640003600
  }
}
```

#### RBAC (Role-Based Access Control)
- **STUDENT**: 기본 사용자
- **MENTOR**: 멘토
- **INSTRUCTOR**: 교수/강사
- **ADMIN**: 관리자

### 5.2 데이터 보안

#### 암호화
- **전송 중**: HTTPS (TLS 1.3)
- **저장 시**:
  - 비밀번호: bcrypt (salt rounds: 10)
  - 민감 정보: AES-256

#### SQL Injection 방지
- Prisma ORM 사용 (파라미터화된 쿼리)
- 입력 검증

#### XSS 방지
- CSP (Content Security Policy)
- 입력 sanitization (DOMPurify)

#### CSRF 방지
- CSRF 토큰
- SameSite Cookie

---

## 6. 성능 최적화

### 6.1 프론트엔드 최적화

#### 코드 스플리팅
```typescript
// Dynamic Import
const Editor = dynamic(() => import('@/components/Editor'), {
  loading: () => <EditorSkeleton />,
  ssr: false, // IDE는 SSR 불필요
});
```

#### 이미지 최적화
```typescript
import Image from 'next/image';

<Image
  src="/avatar.jpg"
  width={100}
  height={100}
  alt="Avatar"
  placeholder="blur"
/>
```

#### 캐싱 전략
- **Static Assets**: 1년 캐시
- **API Response**: React Query 캐시 (5분)
- **User Data**: LocalStorage

### 6.2 백엔드 최적화

#### 데이터베이스 인덱스
```prisma
model User {
  id    String @id
  email String @unique

  @@index([email])
}

model Post {
  id       String @id
  authorId String

  @@index([authorId])
}
```

#### Redis 캐싱
```typescript
async findUserById(id: string) {
  // 캐시 확인
  const cached = await this.redis.get(`user:${id}`);
  if (cached) return JSON.parse(cached);

  // DB 조회
  const user = await this.prisma.user.findUnique({ where: { id } });

  // 캐시 저장 (TTL: 1시간)
  await this.redis.setex(`user:${id}`, 3600, JSON.stringify(user));

  return user;
}
```

#### N+1 쿼리 방지
```typescript
// Bad: N+1 Problem
const courses = await prisma.course.findMany();
for (const course of courses) {
  course.instructor = await prisma.user.findUnique({ where: { id: course.instructorId } });
}

// Good: Include
const courses = await prisma.course.findMany({
  include: { instructor: true }
});
```

---

## 7. 모니터링 및 로깅

### 7.1 메트릭 수집 (Prometheus)

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'wkucrew-api'
    static_configs:
      - targets: ['api:3000']
```

### 7.2 대시보드 (Grafana)

**주요 메트릭**:
- Request Rate (req/s)
- Response Time (p50, p95, p99)
- Error Rate (%)
- Database Connection Pool
- Memory Usage
- CPU Usage

### 7.3 에러 추적 (Sentry)

```typescript
import * as Sentry from '@sentry/nestjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});
```

---

## 8. 확장성 전략

### 8.1 수평 확장 (Horizontal Scaling)

#### API 서버
- ECS Auto Scaling
- Target CPU: 70%
- Min Instances: 2
- Max Instances: 10

#### 데이터베이스
- Read Replica (최대 5개)
- 읽기/쓰기 분리

### 8.2 수직 확장 (Vertical Scaling)

#### 인스턴스 타입 업그레이드
- t3.medium → t3.large → t3.xlarge
- RDS: db.t3.medium → db.r6g.large

---

**문서 버전**: v1.0
**작성일**: 2026-01-22
**작성자**: WKU Software Crew 개발팀
**검토자**: CTO
**다음 리뷰 예정일**: 2026-03-22
