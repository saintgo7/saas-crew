# Development Log - 2026-01-24

## Session Summary

**Date**: 2026-01-24
**Duration**: Full day session
**Primary Goal**: Deploy frontend to production via Cloudflare Tunnel

---

## Work Completed

### 1. Cloudflare Pages Attempt (Abandoned)

**Initial Approach**: Deploy Next.js frontend to Cloudflare Pages

**Issues Encountered**:
- `@cloudflare/next-on-pages` only supports Next.js 13/14, not Next.js 16
- Attempted `@opennextjs/cloudflare` (OpenNext) - deploys to Workers, not Pages
- Cloudflare Pages requires `nodejs_compat` flag which can't be set via CLI

**Decision**: Abandoned Cloudflare Pages approach in favor of Docker + Tunnel

### 2. Docker + Cloudflare Tunnel Deployment (Successful)

**Architecture**:
```
Internet → Cloudflare Tunnel → ws-248-247 Server
                                ├── crew-web:3000
                                ├── crew-api:4000
                                └── crew-tunnel
```

**Files Created/Modified**:

| File | Action | Description |
|------|--------|-------------|
| `deployments/ws-248-247/docker-compose.yml` | Modified | Added crew-web service |
| `deployments/ws-248-247/deploy.sh` | Modified | Updated for both API and web |
| `deployments/ws-248-247/README.md` | Modified | Updated architecture docs |
| `apps/web/Dockerfile` | Existing | Uses standalone output mode |

### 3. Cloudflare Tunnel Configuration

**Tunnel**: crew-api-tunnel (ID: e511a3df-e67f-45c3-bc15-428e4b8043b2)

**Routes Added**:
| Hostname | Service |
|----------|---------|
| crew-api.abada.kr | http://crew-api:4000 |
| crew.abada.kr | http://crew-web:3000 |

**Configuration Steps**:
1. Zero Trust Dashboard > Networks > Tunnels
2. crew-api-tunnel > Configure
3. Published application routes > Add
4. Added crew.abada.kr → http://crew-web:3000

### 4. Health Check Fix

**Problem**: Docker health check using `wget` failed in Alpine container

**Solution**: Changed to node-based health check in docker-compose.yml:
```yaml
healthcheck:
  test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
```

### 5. Next.js Upgrade

**Before**: Next.js 15.5.2 (downgraded for Cloudflare Pages compatibility)
**After**: Next.js 16.1.4 (latest)

**Changes**:
- Upgraded `next` package to 16.1.4
- Removed `@cloudflare/next-on-pages`, `@opennextjs/cloudflare`, `wrangler`
- Simplified `next.config.js` (removed CF_PAGES conditionals)

### 6. CORS Fix

**Problem**: Frontend getting "Failed to fetch" errors

**Root Cause**: Environment variable name mismatch
- API code expects: `ALLOWED_ORIGINS`
- docker-compose.yml had: `CORS_ORIGIN`

**Solution**: Updated docker-compose.yml:
```yaml
# Before
CORS_ORIGIN: https://crew.abada.kr

# After
ALLOWED_ORIGINS: https://crew.abada.kr
```

### 7. Sample Data

**Added 3 sample projects to database**:
1. WKU Software Crew 웹사이트
2. 학생 포트폴리오 플랫폼
3. 캠퍼스 이벤트 앱

---

## Git Commits

| Hash | Message |
|------|---------|
| d91913f | feat(deploy): add frontend Docker deployment via Cloudflare Tunnel |
| 05c9b46 | chore: upgrade Next.js to 16.1.4 and remove Cloudflare Pages deps |
| 6924bb9 | fix(deploy): use Docker health status instead of wget |

---

## Current State

### Live URLs
- **Frontend**: https://crew.abada.kr - Working
- **API**: https://crew-api.abada.kr - Working
- **API Docs**: https://crew-api.abada.kr/api/docs - Working

### Docker Containers (ws-248-247)
| Container | Image | Status |
|-----------|-------|--------|
| crew-web | crew-web:latest | Healthy |
| crew-api | crew-api:latest | Healthy |
| crew-tunnel | cloudflare/cloudflared:latest | Running |

### Tech Stack
| Component | Version |
|-----------|---------|
| Next.js | 16.1.4 |
| NestJS | 11.x |
| PostgreSQL | 16 |
| Node.js | 20 |

---

## Known Issues

1. **Seed Script**: `prisma db seed` fails with TypeScript module error
   - Workaround: Insert sample data via SQL directly
   - TODO: Fix seed script for ESM compatibility

2. **Docker Compose Warning**: `version` attribute is obsolete
   - Non-blocking, just a warning

---

## Files to Review for Next Session

1. `CLAUDE.md` - Project overview and quick reference
2. `docs/DEPLOYMENT_KO.md` - Korean deployment guide
3. `docs/SECRETS.md` - Secrets management
4. `deployments/ws-248-247/` - All deployment configs

---

## Next Steps (Suggested)

1. Fix Prisma seed script for ESM
2. Add GitHub Actions for CI/CD
3. Set up monitoring/alerting
4. Add more sample data (courses, communities)
5. Configure automatic SSL certificate renewal (handled by Cloudflare)
