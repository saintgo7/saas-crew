# Plan 07-01: E2E 테스트 완성 및 커버리지 향상

## Goal
웹 E2E 테스트 시나리오 확대, API 단위 테스트 추가, 통합 테스트 작성하여 테스트 커버리지를 60%에서 80%로 향상

## Status
- **Phase**: 7 (Testing & Quality)
- **Effort**: 2-3 days
- **Parallelizable**: Yes (웹/API 테스트 동시 작업 가능)
- **Depends on**: None (Phase 1-6 완료)

## Context
```typescript
// 현재 상태
- API E2E: 100+ 케이스 (auth, users, projects, courses, community) ✅
- 웹 E2E: 8개 파일 (home, courses, community, navigation, search, authenticated)
- 단위 테스트: 6개 서비스 (.spec.ts)
- 통합 테스트: 없음

// 목표
- 웹 E2E: 핵심 유저 플로우 완성 (회원가입→프로젝트 생성→코스 수강)
- API 단위 테스트: 모든 서비스 80%+ 커버리지
- 통합 테스트: 멀티모듈 플로우 (프로젝트 생성→멤버 추가→코스 연동)
```

## Pre-flight Checks
```xml
<preflight>
  <check>
    <type>file_exists</type>
    <path>apps/web/e2e/playwright.config.ts</path>
    <reason>Playwright 설정 존재 확인</reason>
  </check>
  <check>
    <type>file_exists</type>
    <path>apps/api/test/jest-e2e.json</path>
    <reason>Jest E2E 설정 존재 확인</reason>
  </check>
  <check>
    <type>command</type>
    <command>pnpm list @playwright/test</command>
    <reason>Playwright 설치 확인</reason>
  </check>
  <check>
    <type>command</type>
    <command>pnpm list @nestjs/testing</command>
    <reason>NestJS Testing 설치 확인</reason>
  </check>
</preflight>
```

## Tasks

### Task 1: 웹 E2E 핵심 플로우 테스트 추가
```xml
<task id="1" type="implementation">
  <title>웹 E2E 핵심 유저 플로우 테스트</title>
  <complexity>medium</complexity>
  <estimated_time>4-6 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/web/e2e/tests/user-journey.spec.ts</file>
      <action>create</action>
      <description>
        전체 유저 여정 테스트:
        - 회원가입 (GitHub OAuth 모킹)
        - 프로필 설정 (이름, 학년, 부서)
        - 대시보드 접근
        - 프로젝트 생성
        - 코스 수강 신청
        - 커뮤니티 게시글 작성
      </description>
    </subtask>

    <subtask>
      <file>apps/web/e2e/tests/project-workflow.spec.ts</file>
      <action>create</action>
      <description>
        프로젝트 관리 플로우:
        - 프로젝트 생성 폼 작성
        - 태그 추가
        - 멤버 초대
        - 프로젝트 수정
        - 프로젝트 삭제 (확인 모달)
      </description>
    </subtask>

    <subtask>
      <file>apps/web/e2e/tests/course-enrollment.spec.ts</file>
      <action>create</action>
      <description>
        코스 수강 플로우:
        - 코스 목록 조회
        - 코스 상세 페이지
        - 수강 신청 버튼
        - 진도 업데이트
        - 과제 제출
      </description>
    </subtask>

    <subtask>
      <file>apps/web/e2e/tests/error-handling.spec.ts</file>
      <action>create</action>
      <description>
        에러 처리 시나리오:
        - 404 페이지 표시
        - 401 인증 실패
        - 403 권한 부족
        - 네트워크 에러 재시도
        - Toast 에러 메시지
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter web test:e2e tests/user-journey.spec.ts</step>
    <step>pnpm --filter web test:e2e tests/project-workflow.spec.ts</step>
    <step>pnpm --filter web test:e2e tests/course-enrollment.spec.ts</step>
    <step>pnpm --filter web test:e2e tests/error-handling.spec.ts</step>
    <expected>모든 E2E 테스트 통과 (4/4 파일)</expected>
  </validation>
</task>
```

### Task 2: API 단위 테스트 추가 (누락 서비스)
```xml
<task id="2" type="implementation">
  <title>API 서비스 단위 테스트 작성</title>
  <complexity>medium</complexity>
  <estimated_time>6-8 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/src/enrollments/enrollments.service.spec.ts</file>
      <action>create</action>
      <description>
        EnrollmentsService 테스트:
        - enroll() - 코스 등록
        - unenroll() - 등록 취소
        - findUserEnrollments() - 사용자 수강 목록
        - 중복 등록 방지
        - 비공개 코스 등록 차단
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/chapters/chapters.service.spec.ts</file>
      <action>create</action>
      <description>
        ChaptersService 테스트:
        - create() - 챕터 생성
        - update() - 챕터 수정
        - delete() - 챕터 삭제
        - findByCourseId() - 코스별 챕터 목록
        - 순서 관리
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/progress/progress.service.spec.ts</file>
      <action>create</action>
      <description>
        ProgressService 테스트:
        - updateProgress() - 진도 업데이트
        - calculateCompletionRate() - 완료율 계산
        - markChapterComplete() - 챕터 완료 처리
        - 비디오 위치 저장
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/auth/auth.service.spec.ts</file>
      <action>create</action>
      <description>
        AuthService 테스트:
        - validateUser() - 사용자 검증
        - login() - 로그인
        - validateToken() - JWT 토큰 검증
        - refreshToken() - 토큰 갱신
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/search/search.service.spec.ts</file>
      <action>create</action>
      <description>
        SearchService 테스트:
        - searchProjects() - 프로젝트 검색
        - searchCourses() - 코스 검색
        - searchPosts() - 게시글 검색
        - 태그 필터링
        - 페이지네이션
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter api test enrollments.service.spec.ts</step>
    <step>pnpm --filter api test chapters.service.spec.ts</step>
    <step>pnpm --filter api test progress.service.spec.ts</step>
    <step>pnpm --filter api test auth.service.spec.ts</step>
    <step>pnpm --filter api test search.service.spec.ts</step>
    <expected>모든 단위 테스트 통과 (5/5 파일)</expected>
  </validation>
</task>
```

### Task 3: 통합 테스트 작성 (멀티모듈 플로우)
```xml
<task id="3" type="implementation">
  <title>통합 테스트 시나리오 작성</title>
  <complexity>high</complexity>
  <estimated_time>4-6 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/test/integration/project-member-flow.e2e-spec.ts</file>
      <action>create</action>
      <description>
        프로젝트-멤버 통합 플로우:
        1. 프로젝트 생성 (ProjectsService)
        2. 멤버 추가 (ProjectMembersService)
        3. 멤버 권한 검증 (AuthGuard)
        4. 프로젝트 수정 (권한 있는 멤버만)
        5. 멤버 제거
        6. 프로젝트 삭제 시 멤버십 CASCADE 확인
      </description>
    </subtask>

    <subtask>
      <file>apps/api/test/integration/course-enrollment-progress.e2e-spec.ts</file>
      <action>create</action>
      <description>
        코스-수강-진도 통합 플로우:
        1. 코스 생성 (CoursesService)
        2. 챕터 추가 (ChaptersService)
        3. 수강 신청 (EnrollmentsService)
        4. 진도 업데이트 (ProgressService)
        5. 완료율 계산 검증
        6. 수강 취소 시 진도 데이터 처리
      </description>
    </subtask>

    <subtask>
      <file>apps/api/test/integration/community-interaction.e2e-spec.ts</file>
      <action>create</action>
      <description>
        커뮤니티 상호작용 플로우:
        1. 게시글 작성 (PostsService)
        2. 댓글 작성 (CommentsService)
        3. 투표 (VotesService)
        4. 베스트 답변 선택
        5. 게시글 삭제 시 댓글/투표 CASCADE
        6. 조회수 증가 로직
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter api test:e2e integration/project-member-flow.e2e-spec.ts</step>
    <step>pnpm --filter api test:e2e integration/course-enrollment-progress.e2e-spec.ts</step>
    <step>pnpm --filter api test:e2e integration/community-interaction.e2e-spec.ts</step>
    <expected>모든 통합 테스트 통과 (3/3 파일)</expected>
  </validation>
</task>
```

### Task 4: 테스트 커버리지 측정 및 리포트
```xml
<task id="4" type="verification">
  <title>테스트 커버리지 측정</title>
  <complexity>low</complexity>
  <estimated_time>1-2 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/package.json</file>
      <action>edit</action>
      <description>
        test:cov 스크립트 추가:
        "test:cov": "jest --coverage --coverageDirectory=coverage"
      </description>
    </subtask>

    <subtask>
      <file>apps/web/package.json</file>
      <action>edit</action>
      <description>
        E2E 커버리지 스크립트 추가:
        "test:e2e:cov": "playwright test --reporter=html,json"
      </description>
    </subtask>

    <subtask>
      <file>docs/TEST_COVERAGE_REPORT.md</file>
      <action>create</action>
      <description>
        커버리지 리포트 생성:
        - 라인 커버리지 (목표 80%+)
        - 브랜치 커버리지 (목표 75%+)
        - 함수 커버리지 (목표 80%+)
        - 미커버 영역 식별
        - 개선 계획
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter api test:cov</step>
    <step>pnpm --filter web test:e2e:cov</step>
    <step>cat coverage/coverage-summary.json | grep "total"</step>
    <expected>전체 커버리지 80% 이상 달성</expected>
  </validation>
</task>
```

## Success Criteria
```xml
<success>
  <criterion>웹 E2E 테스트 12개 이상 (기존 8 + 신규 4)</criterion>
  <criterion>API 단위 테스트 11개 이상 (기존 6 + 신규 5)</criterion>
  <criterion>통합 테스트 3개 추가 (멀티모듈 플로우)</criterion>
  <criterion>전체 테스트 커버리지 80% 이상</criterion>
  <criterion>모든 테스트 CI/CD에서 통과</criterion>
  <criterion>TEST_COVERAGE_REPORT.md 문서 완성</criterion>
</success>
```

## Files to Create/Modify
```
apps/web/e2e/tests/user-journey.spec.ts           [NEW]
apps/web/e2e/tests/project-workflow.spec.ts       [NEW]
apps/web/e2e/tests/course-enrollment.spec.ts      [NEW]
apps/web/e2e/tests/error-handling.spec.ts         [NEW]

apps/api/src/enrollments/enrollments.service.spec.ts [NEW]
apps/api/src/chapters/chapters.service.spec.ts       [NEW]
apps/api/src/progress/progress.service.spec.ts       [NEW]
apps/api/src/auth/auth.service.spec.ts               [NEW]
apps/api/src/search/search.service.spec.ts           [NEW]

apps/api/test/integration/project-member-flow.e2e-spec.ts        [NEW]
apps/api/test/integration/course-enrollment-progress.e2e-spec.ts [NEW]
apps/api/test/integration/community-interaction.e2e-spec.ts      [NEW]

apps/api/package.json                              [EDIT - test:cov script]
apps/web/package.json                              [EDIT - test:e2e:cov script]
docs/TEST_COVERAGE_REPORT.md                       [NEW]
```

## Rollback Plan
```xml
<rollback>
  <step>git stash all new test files</step>
  <step>git checkout package.json (revert script changes)</step>
  <step>rm -rf coverage/ playwright-report/ test-results/</step>
  <reason>테스트 파일은 기능 코드에 영향 없음, 안전하게 제거 가능</reason>
</rollback>
```

## Notes
- 웹 E2E와 API 단위 테스트는 병렬 작업 가능
- Ralph Loop 활용: 첫 번째 E2E 테스트 패턴을 학습하여 나머지 자동 생성
- 통합 테스트는 API E2E 테스트 구조 재사용
- 커버리지 목표 미달 시 Task 2 추가 단위 테스트 작성
