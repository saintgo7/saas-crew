# Plan 07-03: 성능 최적화 및 모니터링

## Goal
API 응답시간 <200ms (p95) 달성, 번들 크기 최적화, 데이터베이스 쿼리 최적화, 성능 테스트 자동화로 베타 런칭 준비

## Status
- **Phase**: 7 (Testing & Quality)
- **Effort**: 2-3 days
- **Parallelizable**: Yes (프론트엔드/백엔드 최적화 병렬 가능)
- **Depends on**: None (독립적 실행 가능)

## Context
```typescript
// 현재 성능 상태 (추정)
- API 응답시간: 불명 (측정 필요)
- 번들 크기: ~500KB (gzip 전, 측정 필요)
- 데이터베이스: N+1 쿼리 가능성 (Prisma include)
- 캐싱: ❌ 미구현
- CDN: ⚠️ Cloudflare Pages 예정

// 성능 목표
- API p95: <200ms
- API p99: <500ms
- 첫 페이지 로드: <3초
- Lighthouse 점수: >90
- 번들 크기: <300KB (gzip)
- 데이터베이스 쿼리: <100ms
```

## Pre-flight Checks
```xml
<preflight>
  <check>
    <type>command</type>
    <command>pnpm list @prisma/client</command>
    <reason>Prisma 설치 확인</reason>
  </check>
  <check>
    <type>command</type>
    <command>pnpm list next</command>
    <reason>Next.js 설치 확인</reason>
  </check>
  <check>
    <type>file_exists</type>
    <path>apps/web/next.config.js</path>
    <reason>Next.js 설정 파일 확인</reason>
  </check>
  <check>
    <type>command</type>
    <command>docker ps | grep postgres</command>
    <reason>PostgreSQL 실행 확인</reason>
  </check>
</preflight>
```

## Tasks

### Task 1: API 성능 측정 및 프로파일링
```xml
<task id="1" type="measurement">
  <title>API 응답시간 측정 및 병목 지점 식별</title>
  <complexity>medium</complexity>
  <estimated_time>3-4 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/src/common/interceptors/logging.interceptor.ts</file>
      <action>create</action>
      <description>
        성능 로깅 인터셉터:
        - 요청 시작/종료 시간 측정
        - 응답시간 로깅 (ms)
        - p50, p95, p99 집계
        - 느린 엔드포인트 식별 (>200ms)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/main.ts</file>
      <action>edit</action>
      <description>
        전역 인터셉터 등록:
        ```typescript
        app.useGlobalInterceptors(new LoggingInterceptor())
        ```
      </description>
    </subtask>

    <subtask>
      <file>scripts/performance/api-benchmark.ts</file>
      <action>create</action>
      <description>
        API 벤치마크 스크립트:
        - Autocannon 또는 k6 사용
        - 주요 엔드포인트 부하 테스트
        - 100 RPS, 1000 RPS 시나리오
        - 응답시간 분포 측정
        - 리포트 생성 (JSON/HTML)
      </description>
    </subtask>

    <subtask>
      <file>docs/PERFORMANCE_BASELINE.md</file>
      <action>create</action>
      <description>
        성능 베이스라인 문서:
        - 엔드포인트별 응답시간
        - p50, p95, p99 통계
        - 병목 지점 (DB 쿼리, 외부 API)
        - 개선 전/후 비교
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>node scripts/performance/api-benchmark.ts</step>
    <step>cat apps/api/logs/performance.log | grep "p95"</step>
    <expected>모든 주요 엔드포인트 응답시간 측정 완료</expected>
  </validation>
</task>
```

### Task 2: 데이터베이스 쿼리 최적화
```xml
<task id="2" type="optimization">
  <title>N+1 쿼리 제거 및 인덱스 추가</title>
  <complexity>high</complexity>
  <estimated_time>4-6 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/prisma/schema.prisma</file>
      <action>edit</action>
      <description>
        인덱스 추가:
        ```prisma
        model Project {
          // ...
          @@index([userId])           // 사용자별 프로젝트 조회
          @@index([isPublic])          // 공개 프로젝트 필터링
          @@index([createdAt])         // 최신순 정렬
          @@index([userId, isPublic])  // 복합 인덱스
        }

        model Post {
          // ...
          @@index([authorId])
          @@index([createdAt])
          @@index([slug])              // 고유 슬러그 검색
        }

        model Enrollment {
          // ...
          @@index([userId, courseId])  // 수강 여부 확인
        }
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/projects/projects.service.ts</file>
      <action>review</action>
      <description>
        N+1 쿼리 제거:
        - findAll() - include members 대신 select 최소화
        - findOne() - 필요한 관계만 포함
        - Prisma.$queryRaw 고려 (복잡한 집계)

        Before:
        ```typescript
        return this.prisma.project.findMany({
          include: { members: { include: { user: true } } } // N+1
        })
        ```

        After:
        ```typescript
        return this.prisma.project.findMany({
          select: {
            id: true,
            name: true,
            _count: { select: { members: true } } // 카운트만
          }
        })
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/decorators/paginate.decorator.ts</file>
      <action>create</action>
      <description>
        페이지네이션 최적화:
        - Cursor-based pagination 구현
        - OFFSET 대신 lastId 사용
        - 대량 데이터 처리 효율화
      </description>
    </subtask>

    <subtask>
      <file>scripts/db/analyze-queries.ts</file>
      <action>create</action>
      <description>
        쿼리 분석 스크립트:
        - Prisma.$on('query') 이벤트 리스닝
        - 느린 쿼리 로깅 (>100ms)
        - EXPLAIN ANALYZE 출력
        - 최적화 제안
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm prisma migrate dev --name add_indexes</step>
    <step>node scripts/db/analyze-queries.ts</step>
    <step>Check: 모든 주요 쿼리 <100ms</step>
    <expected>N+1 쿼리 제거, 인덱스 적용, 쿼리 시간 단축</expected>
  </validation>
</task>
```

### Task 3: 프론트엔드 번들 최적화
```xml
<task id="3" type="optimization">
  <title>Next.js 번들 크기 최적화</title>
  <complexity>medium</complexity>
  <estimated_time>4-5 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/web/next.config.js</file>
      <action>edit</action>
      <description>
        번들 최적화 설정:
        ```javascript
        module.exports = {
          // Tree-shaking
          webpack: (config) => {
            config.optimization.usedExports = true
            return config
          },

          // Dynamic imports
          compiler: {
            removeConsole: process.env.NODE_ENV === 'production',
          },

          // Image optimization
          images: {
            formats: ['image/avif', 'image/webp'],
            deviceSizes: [640, 750, 828, 1080, 1200],
          },

          // Compression
          compress: true,
          swcMinify: true,
        }
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/web/package.json</file>
      <action>edit</action>
      <description>
        번들 분석 스크립트 추가:
        ```json
        "analyze": "ANALYZE=true next build",
        "analyze:browser": "ANALYZE=true BUNDLE_ANALYZE=browser next build",
        "analyze:server": "ANALYZE=true BUNDLE_ANALYZE=server next build"
        ```

        @next/bundle-analyzer 설치:
        ```bash
        pnpm add -D @next/bundle-analyzer
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/web/app/layout.tsx</file>
      <action>review</action>
      <description>
        폰트 최적화:
        - next/font 사용 (로컬 폰트 호스팅)
        - Preload 최소화
        - font-display: swap

        ```typescript
        import { Inter } from 'next/font/google'
        const inter = Inter({ subsets: ['latin'], display: 'swap' })
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/web/components/*/index.tsx</file>
      <action>review</action>
      <description>
        컴포넌트 동적 임포트:
        - Heavy 컴포넌트 lazy loading
        - React.lazy + Suspense
        - next/dynamic 사용

        ```typescript
        const HeavyChart = dynamic(() => import('./HeavyChart'), {
          ssr: false,
          loading: () => <Spinner />,
        })
        ```
      </description>
    </subtask>

    <subtask>
      <file>docs/BUNDLE_ANALYSIS.md</file>
      <action>create</action>
      <description>
        번들 분석 리포트:
        - 총 번들 크기 (gzip 전/후)
        - 페이지별 chunk 크기
        - 큰 의존성 식별 (>50KB)
        - 최적화 전/후 비교
        - Code splitting 전략
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter web analyze</step>
    <step>Check bundle size: < 300KB (gzip)</step>
    <step>Check first load JS: < 200KB</step>
    <expected>번들 크기 목표 달성 (300KB 이하)</expected>
  </validation>
</task>
```

### Task 4: 캐싱 전략 구현
```xml
<task id="4" type="implementation">
  <title>API 응답 캐싱 및 Redis 통합</title>
  <complexity>medium</complexity>
  <estimated_time>4-5 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/src/cache/cache.module.ts</file>
      <action>create</action>
      <description>
        Redis 캐시 모듈:
        - @nestjs/cache-manager 사용
        - Redis 연결 설정
        - TTL 설정 (기본 60초)
        - 캐시 키 전략
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/interceptors/cache.interceptor.ts</file>
      <action>create</action>
      <description>
        캐시 인터셉터:
        - GET 요청만 캐싱
        - 사용자별 캐시 분리
        - Cache-Control 헤더 설정
        - 조건부 캐싱 (쿼리 파라미터 고려)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/projects/projects.controller.ts</file>
      <action>edit</action>
      <description>
        프로젝트 목록 캐싱:
        ```typescript
        @UseInterceptors(CacheInterceptor)
        @CacheTTL(300) // 5분
        @Get()
        async findAll(@Query() query: FilterDto) {
          // 공개 프로젝트 목록은 5분 캐싱
        }
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/courses/courses.service.ts</file>
      <action>edit</action>
      <description>
        코스 데이터 캐싱:
        - 인기 코스 목록 (30분)
        - 코스 상세 (10분)
        - 캐시 무효화 (코스 수정 시)
      </description>
    </subtask>

    <subtask>
      <file>apps/web/next.config.js</file>
      <action>edit</action>
      <description>
        Next.js ISR (Incremental Static Regeneration):
        ```javascript
        // app/projects/[id]/page.tsx
        export const revalidate = 60 // 60초마다 재생성
        ```
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>docker run -d -p 6379:6379 redis:7</step>
    <step>curl http://localhost:4000/api/projects (첫 요청)</step>
    <step>curl http://localhost:4000/api/projects (캐시 응답)</step>
    <step>Check: X-Cache-Hit header 또는 응답시간 <10ms</step>
    <expected>캐싱으로 응답시간 90% 단축</expected>
  </validation>
</task>
```

### Task 5: 성능 테스트 자동화 및 모니터링
```xml
<task id="5" type="testing">
  <title>성능 테스트 및 Lighthouse CI</title>
  <complexity>medium</complexity>
  <estimated_time>3-4 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>.github/workflows/performance.yml</file>
      <action>create</action>
      <description>
        성능 테스트 CI:
        ```yaml
        name: Performance Tests
        on: [push, pull_request]

        jobs:
          api-performance:
            runs-on: ubuntu-latest
            steps:
              - uses: actions/checkout@v3
              - name: Run API benchmark
                run: |
                  pnpm install
                  node scripts/performance/api-benchmark.ts
              - name: Check p95 < 200ms
                run: |
                  if [ $P95 -gt 200 ]; then exit 1; fi

          lighthouse:
            runs-on: ubuntu-latest
            steps:
              - uses: actions/checkout@v3
              - name: Run Lighthouse CI
                uses: treosh/lighthouse-ci-action@v9
                with:
                  urls: |
                    http://localhost:3000
                    http://localhost:3000/projects
                    http://localhost:3000/courses
                  uploadArtifacts: true
        ```
      </description>
    </subtask>

    <subtask>
      <file>lighthouserc.js</file>
      <action>create</action>
      <description>
        Lighthouse 설정:
        ```javascript
        module.exports = {
          ci: {
            collect: {
              numberOfRuns: 3,
              startServerCommand: 'pnpm dev',
              url: ['http://localhost:3000/', 'http://localhost:3000/projects'],
            },
            assert: {
              assertions: {
                'categories:performance': ['error', { minScore: 0.9 }],
                'categories:accessibility': ['warn', { minScore: 0.9 }],
                'categories:best-practices': ['warn', { minScore: 0.9 }],
                'first-contentful-paint': ['warn', { maxNumericValue: 2000 }],
                'interactive': ['error', { maxNumericValue: 3500 }],
              },
            },
          },
        }
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/web/e2e/tests/performance.spec.ts</file>
      <action>enhance</action>
      <description>
        E2E 성능 테스트 강화:
        - 페이지 로드 시간 측정
        - Core Web Vitals (LCP, FID, CLS)
        - 네트워크 요청 수/크기
        - 리소스 로딩 시간
        - 임계값 초과 시 실패
      </description>
    </subtask>

    <subtask>
      <file>docs/PERFORMANCE_REPORT.md</file>
      <action>create</action>
      <description>
        성능 리포트:
        - API 응답시간 (p50, p95, p99)
        - 번들 크기 (최적화 전/후)
        - Lighthouse 점수
        - Core Web Vitals
        - 데이터베이스 쿼리 시간
        - 개선 사항 요약
        - 추가 최적화 계획
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter web test:e2e tests/performance.spec.ts</step>
    <step>lhci autorun</step>
    <step>Check: Lighthouse Performance > 90</step>
    <expected>모든 성능 테스트 통과, Lighthouse 90+ 점수</expected>
  </validation>
</task>
```

## Success Criteria
```xml
<success>
  <criterion>API p95 응답시간 <200ms</criterion>
  <criterion>API p99 응답시간 <500ms</criterion>
  <criterion>번들 크기 <300KB (gzip)</criterion>
  <criterion>Lighthouse Performance 점수 >90</criterion>
  <criterion>First Contentful Paint <2초</criterion>
  <criterion>Time to Interactive <3.5초</criterion>
  <criterion>데이터베이스 쿼리 <100ms</criterion>
  <criterion>Redis 캐싱 적용 (주요 엔드포인트)</criterion>
  <criterion>성능 테스트 CI/CD 통합</criterion>
  <criterion>PERFORMANCE_REPORT.md 문서 완성</criterion>
</success>
```

## Files to Create/Modify
```
apps/api/src/common/interceptors/logging.interceptor.ts      [NEW]
apps/api/src/common/interceptors/cache.interceptor.ts        [NEW]
apps/api/src/cache/cache.module.ts                           [NEW]

apps/api/src/main.ts                                         [EDIT - interceptors]
apps/api/prisma/schema.prisma                                [EDIT - indexes]

apps/web/next.config.js                                      [EDIT - optimization]
apps/web/package.json                                        [EDIT - analyze scripts]

scripts/performance/api-benchmark.ts                         [NEW]
scripts/db/analyze-queries.ts                                [NEW]

.github/workflows/performance.yml                            [NEW]
lighthouserc.js                                              [NEW]

apps/web/e2e/tests/performance.spec.ts                       [ENHANCE]

docs/PERFORMANCE_BASELINE.md                                 [NEW]
docs/BUNDLE_ANALYSIS.md                                      [NEW]
docs/PERFORMANCE_REPORT.md                                   [NEW]
```

## Rollback Plan
```xml
<rollback>
  <step>git revert Prisma schema (remove indexes)</step>
  <step>pnpm prisma migrate dev --name revert_indexes</step>
  <step>git revert next.config.js optimization</step>
  <step>Disable caching interceptor</step>
  <reason>성능 최적화는 점진적 적용 가능, 문제 발생 시 단계별 롤백</reason>
</rollback>
```

## Notes
- 성능 최적화는 측정 → 분석 → 최적화 → 재측정 순서로 진행
- 조기 최적화 금지: 병목 지점 식별 후 우선순위 기반 최적화
- Ralph Loop 활용: 인덱스 추가 패턴 학습 후 다른 모델에 적용
- Performance Agent 활용: 자동 병목 분석 및 최적화 제안
- 캐싱 전략은 데이터 특성에 따라 TTL 조정 (정적 데이터는 길게, 동적 데이터는 짧게)
