# Plan 07-02: 보안 검토 및 강화

## Goal
OWASP Top 10 기반 보안 검토, 인증/권한 강화, XSS/SQL Injection 방어 확인, 보안 헤더 설정으로 베타 런칭 준비

## Status
- **Phase**: 7 (Testing & Quality)
- **Effort**: 1-2 days
- **Parallelizable**: Partially (보안 스캔 도구는 순차 실행)
- **Depends on**: None (독립적 실행 가능)

## Context
```typescript
// 현재 보안 상태
- JWT 인증: ✅ 구현됨 (Passport)
- GitHub OAuth: ⚠️ 설정 필요 (클라이언트 ID/Secret)
- 권한 체계: ✅ RBAC (OWNER, ADMIN, MEMBER)
- HTTPS: ⚠️ 프로덕션 설정 필요
- CORS: ⚠️ 검토 필요
- 보안 헤더: ❌ 미설정

// OWASP Top 10 (2021)
1. Broken Access Control      - 검토 필요
2. Cryptographic Failures      - JWT 강도 확인 필요
3. Injection (SQL, XSS)        - Prisma ORM 사용 (기본 방어)
4. Insecure Design             - 아키텍처 검토
5. Security Misconfiguration   - 환경 변수, CORS, 헤더
6. Vulnerable Components       - npm audit 필요
7. Auth/Session Failures       - JWT 만료, 세션 관리
8. Data Integrity Failures     - 입력 검증 필요
9. Logging Failures            - 로깅 수준 검토
10. SSRF                       - 외부 요청 제한 필요
```

## Pre-flight Checks
```xml
<preflight>
  <check>
    <type>command</type>
    <command>pnpm audit --production</command>
    <reason>의존성 취약점 확인</reason>
  </check>
  <check>
    <type>file_exists</type>
    <path>apps/api/src/auth/guards/jwt-auth.guard.ts</path>
    <reason>JWT Guard 구현 확인</reason>
  </check>
  <check>
    <type>file_exists</type>
    <path>apps/api/src/auth/guards/roles.guard.ts</path>
    <reason>Role Guard 구현 확인</reason>
  </check>
  <check>
    <type>env_var</type>
    <name>JWT_SECRET</name>
    <reason>JWT 시크릿 설정 확인</reason>
  </check>
</preflight>
```

## Tasks

### Task 1: OWASP Top 10 보안 감사
```xml
<task id="1" type="audit">
  <title>OWASP Top 10 기반 보안 취약점 검토</title>
  <complexity>medium</complexity>
  <estimated_time>4-6 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>docs/SECURITY_AUDIT.md</file>
      <action>create</action>
      <description>
        OWASP Top 10 체크리스트:

        1. Broken Access Control
           - [ ] JWT 토큰 검증 (모든 보호된 라우트)
           - [ ] 역할 기반 접근 제어 (RBAC)
           - [ ] 소유권 검증 (본인 리소스만 수정)
           - [ ] API 엔드포인트 권한 매트릭스

        2. Cryptographic Failures
           - [ ] JWT 시크릿 강도 (32+ characters)
           - [ ] bcrypt 해시 라운드 (10+)
           - [ ] HTTPS 강제 (프로덕션)
           - [ ] 민감 데이터 암호화

        3. Injection
           - [ ] Prisma ORM 사용 (SQL Injection 방어)
           - [ ] XSS 방어 (React 기본 이스케이핑)
           - [ ] 입력 검증 (class-validator)
           - [ ] 출력 인코딩

        4-10. [나머지 항목 체크리스트]
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/guards/ownership.guard.ts</file>
      <action>create</action>
      <description>
        소유권 검증 Guard 구현:
        - 리소스 소유자 확인
        - 타인 리소스 접근 차단
        - 에러 핸들링 (403 Forbidden)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/decorators/current-user.decorator.ts</file>
      <action>verify</action>
      <description>
        CurrentUser 데코레이터 검증:
        - JWT 페이로드에서 사용자 추출
        - 타입 안정성 확인
        - 인증 실패 처리
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/auth/strategies/jwt.strategy.ts</file>
      <action>review</action>
      <description>
        JWT Strategy 보안 검토:
        - 토큰 만료 시간 (1시간)
        - 리프레시 토큰 구현 여부
        - 시크릿 노출 방지
        - 알고리즘 강도 (HS256 or RS256)
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter api test guards/ownership.guard.spec.ts</step>
    <step>cat docs/SECURITY_AUDIT.md | grep "\[x\]" | wc -l</step>
    <expected>모든 OWASP Top 10 항목 체크 완료</expected>
  </validation>
</task>
```

### Task 2: 의존성 취약점 스캔 및 수정
```xml
<task id="2" type="security_scan">
  <title>npm audit 및 취약점 패치</title>
  <complexity>low</complexity>
  <estimated_time>2-3 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>package.json</file>
      <action>audit</action>
      <description>
        전체 워크스페이스 의존성 스캔:
        - pnpm audit --production
        - 고위험(Critical/High) 취약점 우선 수정
        - npm audit fix 또는 수동 버전 업그레이드
      </description>
    </subtask>

    <subtask>
      <file>docs/DEPENDENCY_AUDIT.md</file>
      <action>create</action>
      <description>
        의존성 취약점 리포트:
        - 발견된 취약점 목록
        - 심각도별 분류
        - 수정 내역
        - 해결 불가 항목 및 대안
      </description>
    </subtask>

    <subtask>
      <file>.github/workflows/security-scan.yml</file>
      <action>create</action>
      <description>
        자동 보안 스캔 CI:
        - pnpm audit 실행
        - Dependabot 설정
        - 고위험 발견 시 PR 차단
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm audit --production</step>
    <step>pnpm audit --audit-level=moderate</step>
    <expected>Critical/High 취약점 0개</expected>
  </validation>
</task>
```

### Task 3: 보안 헤더 및 CORS 설정
```xml
<task id="3" type="configuration">
  <title>보안 헤더 및 CORS 정책 설정</title>
  <complexity>low</complexity>
  <estimated_time>2-3 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/src/main.ts</file>
      <action>edit</action>
      <description>
        Helmet 미들웨어 추가:
        ```typescript
        import helmet from 'helmet'

        app.use(helmet({
          contentSecurityPolicy: {
            directives: {
              defaultSrc: ["'self'"],
              styleSrc: ["'self'", "'unsafe-inline'"],
              scriptSrc: ["'self'"],
              imgSrc: ["'self'", "data:", "https:"],
            },
          },
          hsts: {
            maxAge: 31536000,
            includeSubDomains: true,
            preload: true,
          },
        }))
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/main.ts</file>
      <action>edit</action>
      <description>
        CORS 정책 강화:
        ```typescript
        app.enableCors({
          origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
          credentials: true,
          methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
          allowedHeaders: ['Content-Type', 'Authorization'],
          maxAge: 3600,
        })
        ```
      </description>
    </subtask>

    <subtask>
      <file>apps/api/.env.example</file>
      <action>edit</action>
      <description>
        보안 관련 환경 변수 추가:
        - ALLOWED_ORIGINS=https://wku-crew.com,https://www.wku-crew.com
        - RATE_LIMIT_TTL=60
        - RATE_LIMIT_MAX=100
        - SESSION_SECRET=[generate strong secret]
      </description>
    </subtask>

    <subtask>
      <file>apps/web/next.config.js</file>
      <action>edit</action>
      <description>
        Next.js 보안 헤더 설정:
        ```javascript
        headers: async () => [
          {
            source: '/(.*)',
            headers: [
              {
                key: 'X-Frame-Options',
                value: 'DENY',
              },
              {
                key: 'X-Content-Type-Options',
                value: 'nosniff',
              },
              {
                key: 'Referrer-Policy',
                value: 'strict-origin-when-cross-origin',
              },
            ],
          },
        ],
        ```
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>curl -I http://localhost:4000/api/health</step>
    <step>Check for: X-Frame-Options, X-Content-Type-Options, Strict-Transport-Security</step>
    <expected>모든 보안 헤더 응답에 포함</expected>
  </validation>
</task>
```

### Task 4: Rate Limiting 및 입력 검증 강화
```xml
<task id="4" type="implementation">
  <title>Rate Limiting 및 입력 검증</title>
  <complexity>medium</complexity>
  <estimated_time>3-4 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/src/common/guards/throttle.guard.ts</file>
      <action>create</action>
      <description>
        Rate Limiting Guard:
        - @nestjs/throttler 사용
        - 기본: 100 requests/60초
        - 로그인: 5 requests/5분
        - 특정 IP 차단 기능
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/pipes/validation.pipe.ts</file>
      <action>enhance</action>
      <description>
        입력 검증 강화:
        - whitelist: true (허용되지 않은 속성 제거)
        - forbidNonWhitelisted: true (에러 발생)
        - transform: true (타입 변환)
        - disableErrorMessages: false (개발), true (프로덕션)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/users/dto/update-user.dto.ts</file>
      <action>review</action>
      <description>
        DTO 검증 규칙 검토:
        - @IsEmail() - 이메일 형식
        - @IsString() @MinLength() @MaxLength()
        - @IsEnum() - 학년, 부서
        - @IsOptional() - 선택 필드
        - @Transform() - 입력 정제 (trim, lowercase)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/src/common/filters/http-exception.filter.ts</file>
      <action>create</action>
      <description>
        전역 예외 필터:
        - 에러 로깅 (프로덕션)
        - 스택 트레이스 숨기기 (프로덕션)
        - 사용자 친화적 에러 메시지
        - 에러 코드 표준화
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>curl -X POST http://localhost:4000/api/auth/login (101번 반복)</step>
    <step>Check for: 429 Too Many Requests</step>
    <step>pnpm --filter api test common/guards/throttle.guard.spec.ts</step>
    <expected>Rate Limiting 정상 작동</expected>
  </validation>
</task>
```

### Task 5: 보안 테스트 자동화
```xml
<task id="5" type="testing">
  <title>보안 테스트 케이스 작성</title>
  <complexity>medium</complexity>
  <estimated_time>3-4 hours</estimated_time>

  <subtasks>
    <subtask>
      <file>apps/api/test/security/auth-security.e2e-spec.ts</file>
      <action>create</action>
      <description>
        인증 보안 테스트:
        - 유효하지 않은 JWT 토큰 거부
        - 만료된 토큰 거부
        - 토큰 없이 보호된 라우트 접근 차단
        - 잘못된 역할로 접근 차단
        - 타인의 리소스 수정 차단 (403)
      </description>
    </subtask>

    <subtask>
      <file>apps/api/test/security/injection.e2e-spec.ts</file>
      <action>create</action>
      <description>
        Injection 공격 테스트:
        - SQL Injection 시도 (Prisma 방어 확인)
        - XSS 페이로드 입력 (이스케이핑 확인)
        - Command Injection 시도
        - 모든 입력 필드 검증
      </description>
    </subtask>

    <subtask>
      <file>apps/api/test/security/rate-limiting.e2e-spec.ts</file>
      <action>create</action>
      <description>
        Rate Limiting 테스트:
        - 제한 초과 시 429 응답
        - TTL 후 리셋 확인
        - IP별 제한 확인
        - 로그인 엔드포인트 특별 제한
      </description>
    </subtask>

    <subtask>
      <file>apps/api/test/security/cors.e2e-spec.ts</file>
      <action>create</action>
      <description>
        CORS 정책 테스트:
        - 허용된 Origin 통과
        - 허용되지 않은 Origin 차단
        - Credentials 포함 여부
        - Preflight 요청 처리
      </description>
    </subtask>
  </subtasks>

  <validation>
    <step>pnpm --filter api test:e2e security/auth-security.e2e-spec.ts</step>
    <step>pnpm --filter api test:e2e security/injection.e2e-spec.ts</step>
    <step>pnpm --filter api test:e2e security/rate-limiting.e2e-spec.ts</step>
    <step>pnpm --filter api test:e2e security/cors.e2e-spec.ts</step>
    <expected>모든 보안 테스트 통과 (4/4 파일)</expected>
  </validation>
</task>
```

## Success Criteria
```xml
<success>
  <criterion>OWASP Top 10 체크리스트 100% 완료</criterion>
  <criterion>npm audit 고위험 취약점 0개</criterion>
  <criterion>보안 헤더 모든 응답에 포함 (Helmet)</criterion>
  <criterion>CORS 정책 설정 및 테스트 통과</criterion>
  <criterion>Rate Limiting 적용 (100 req/min)</criterion>
  <criterion>보안 테스트 4개 파일 작성 및 통과</criterion>
  <criterion>SECURITY_AUDIT.md 문서 완성</criterion>
</success>
```

## Files to Create/Modify
```
docs/SECURITY_AUDIT.md                                      [NEW]
docs/DEPENDENCY_AUDIT.md                                    [NEW]

apps/api/src/common/guards/ownership.guard.ts               [NEW]
apps/api/src/common/guards/throttle.guard.ts                [NEW]
apps/api/src/common/filters/http-exception.filter.ts        [NEW]

apps/api/src/main.ts                                        [EDIT - Helmet, CORS]
apps/api/.env.example                                       [EDIT - security vars]
apps/web/next.config.js                                     [EDIT - security headers]

apps/api/test/security/auth-security.e2e-spec.ts            [NEW]
apps/api/test/security/injection.e2e-spec.ts                [NEW]
apps/api/test/security/rate-limiting.e2e-spec.ts            [NEW]
apps/api/test/security/cors.e2e-spec.ts                     [NEW]

.github/workflows/security-scan.yml                         [NEW]
```

## Rollback Plan
```xml
<rollback>
  <step>git revert main.ts changes (remove Helmet/CORS)</step>
  <step>git revert next.config.js headers</step>
  <step>Remove security test files (no impact on production)</step>
  <reason>보안 설정 롤백 시 이전 상태로 복원</reason>
</rollback>
```

## Notes
- Helmet 설정은 단계적 적용 (CSP 정책 점진적 강화)
- Rate Limiting은 프로덕션에서만 활성화 고려 (개발 시 불편 방지)
- Security Agent 활용: 보안 검토 자동화
- SECURITY_AUDIT.md는 베타 런칭 전 필수 체크리스트로 활용
