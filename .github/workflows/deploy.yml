name: Deploy

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Deploy to Staging (develop branch)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging-crew.abada.kr

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/saas-crew

            # Run staging deployment script
            ./deployments/ws-248-247/deploy-staging.sh

            echo "Staging deployment completed"

      - name: Verify staging health
        run: |
          echo "Waiting for staging to be ready..."
          sleep 30

          for i in {1..10}; do
            if curl -sf https://staging-api-crew.abada.kr/api/health > /dev/null 2>&1; then
              echo "Staging API health check passed"
              break
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

      - name: Create deployment status
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: 'https://staging-crew.abada.kr',
              description: 'Deployed to staging',
              context: 'deployment/staging'
            });

  # ===========================================================================
  # Deploy to Production (main branch)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://crew.abada.kr

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/saas-crew

            # Run production deployment script
            ./deployments/ws-248-247/deploy.sh

            echo "Production deployment completed"

      - name: Verify production health
        run: |
          echo "Waiting for production to be ready..."
          sleep 30

          for i in {1..10}; do
            if curl -sf https://crew-api.abada.kr/api/health > /dev/null 2>&1; then
              echo "Production API health check passed"
              break
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

      - name: Create deployment status
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: 'https://crew.abada.kr',
              description: 'Deployed to production',
              context: 'deployment/production'
            });

      - name: Create release tag
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const shortSha = context.sha.substring(0, 7);

            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: `v${date}-${shortSha}`,
                name: `Production Release ${date}`,
                body: `Deployed to production from commit ${context.sha}\n\n- Frontend: https://crew.abada.kr\n- API: https://crew-api.abada.kr`,
                draft: false,
                prerelease: false
              });
            } catch (e) {
              console.log('Release creation skipped:', e.message);
            }

  # ===========================================================================
  # Notify on Failure (Temporarily Disabled)
  # ===========================================================================
  # notify-failure:
  #   name: Notify on Failure
  #   runs-on: ubuntu-latest
  #   needs: [deploy-staging, deploy-production]
  #   if: |
  #     always() &&
  #     (needs.deploy-staging.result == 'failure' ||
  #      needs.deploy-production.result == 'failure')
  #
  #   steps:
  #     - name: Create failure issue
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const stagingFailed = '${{ needs.deploy-staging.result }}' === 'failure';
  #           const productionFailed = '${{ needs.deploy-production.result }}' === 'failure';
  #
  #           let title = 'Deployment Failed: ';
  #           if (stagingFailed && productionFailed) {
  #             title += 'Staging & Production';
  #           } else if (stagingFailed) {
  #             title += 'Staging';
  #           } else {
  #             title += 'Production';
  #           }
  #
  #           await github.rest.issues.create({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             title: title,
  #             body: `## Deployment Failure Report
  #
  # **Commit**: ${context.sha}
  # **Branch**: ${context.ref}
  # **Workflow Run**: [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
  #
  # ### Status
  # - Staging: ${{ needs.deploy-staging.result }}
  # - Production: ${{ needs.deploy-production.result }}
  #
  # Please investigate and fix the deployment issue.`,
  #             labels: ['deployment', 'bug']
  #           });
